---
// fetch yaml file from data folder
import { platforms } from '../data/partials/platforms.yaml';

import { Picture } from 'astro:assets';

// Define the type for the platforms array
type Platform = {
    name: string;
    category: string;
    image: string;
    link: string;
}

// Define the type for the unique category mapping
type CategoryMap = {[key:string]: Platform[]};


/**
 * Groups "platforms" data by category
 * @param acc - The accumulator object
 * @param platform - The platform object
 * @returns The accumulator object
 */
const groupByCategory = (acc: CategoryMap, platform: Platform) => {
    const category = platform.category.replaceAll('_', ' ');
    if (!acc[category]) {
        acc[category] = [];
    }
    acc[category].push(platform);
    
    return acc
}

/**
 * Capitalize the first letter of each word in a string
 * @param str - The string to capitalize
 * @returns The capitalized string
 */
const capitalize = (str:string) => {
    const lowercaseWords = ['a', 'an', 'and', 'as', 'at', 'but', 'by', 'for', 'in', 'of', 'on', 'or', 'the', 'to', 'with'];
    return str.split(' ').map(word => {
        return lowercaseWords.includes(word) ? word : `${word.charAt(0).toUpperCase()}${word.slice(1)}`;
    }).join(' ');
}

const uniqueCategories = platforms.reduce(groupByCategory, {});

---
<!-- 
    Renders a custom tabbed content grouped by category
    for more details, see:
        - docs-astro/markdoc.config.mjs for Component props schema.
-->

<div>
    <div class="flex flex-wrap gap-2 m-1">
        <!-- tabs -->
        {
            Object.keys(uniqueCategories).map((category:string, index:number) => (
                <button 
                    class={`tab-button fw-semibold bg-transparent p-2 mt-0! text-sm! cursor-pointer rounded-md hover:text-ddpurple hover:shadow-[2px_5px_12px_rgba(0,0,0,.1)] ${!index ? 'active' : ''}`}
                    data-tab={category}
                    aria-selected={index === 0}
                >
                    {capitalize(category)}
                </button>
            ))
        }
    </div>
    
    <div class="flex flex-wrap gap-x-4 gap-y-4">
        <!-- tab panels -->
        {
            Object.entries(uniqueCategories).map(([category, platforms], index) => (
                <div 
                    class={`tab-panel hidden ${!index ? 'active' : ''}`}
                    data-tab={category}
                >
                    <div class="flex flex-wrap gap-x-8 gap-y-6">
                        {(platforms as Platform[]).map((platform) => (
                            <a href={`/${platform.link}`}>
                                <Picture 
                                    src={`https://datadog-docs.imgix.net/images/icons/${platform.image}`}
                                    alt={platform.name} 
                                    width={96}
                                    height={96}
                                    class="rounded-md border border-gray-200 shadow-sm hover:shadow-[2px_5px_5px_rgba(0,0,0,.5)]" 
                                />
                            </a>
                        ))}
                    </div>
                </div>
            ))
        }
    </div>
</div>

<style>
    .tab-button.active {
        background-color: #632CA6;
        color: white;
    }
    
    .tab-panel.active {
        display: block;
    }
    img {
        margin-top: 0 !important;
    }
</style>

<script>
    document.querySelectorAll('.tab-button').forEach(button => {
        button.addEventListener('click', () => {
            // Remove active class from all buttons and panels
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
                btn.setAttribute('aria-selected', 'false');
            });
            document.querySelectorAll('.tab-panel').forEach(panel => {
                panel.classList.remove('active');
            });
            
            // Add active class to clicked button and corresponding panel
            button.classList.add('active');
            button.setAttribute('aria-selected', 'true');
            const tabId = button.getAttribute('data-tab');
            document.querySelector(`.tab-panel[data-tab="${tabId}"]`)?.classList.add('active');
        });
    });
</script>